# 部署指南

本文档提供了完整的部署流程和排障指南，确保您的应用在Replit上成功部署并正常运行。

## 部署流程

### 1. 构建与运行命令设置

在Replit部署中配置以下命令：

**构建命令 (Build Command):**
```bash
bash deploy-fix.sh
```

**运行命令 (Run Command):**
```bash
NODE_ENV=production node dist/start.js
```

### 2. 环境变量配置

确保以下环境变量已正确设置（详见`环境变量配置.md`）：

- `NODE_ENV=production`
- 所有必要的API密钥 (GEMINI_API_KEY, DEEPSEEK_API_KEY等)
- 数据库连接字符串 (DATABASE_URL)

### 3. 部署后验证

部署成功后，访问以下路径检查应用状态：

- `/` - 主应用页面
- `/health.html` - 健康检查页面（如果主页面无法访问）

## 常见问题与解决方案

### 问题1: 页面显示"Health check OK"但看不到应用界面

**原因:** 静态资源未被正确服务

**解决方案:**
- 使用`deploy-fix.sh`脚本，它能自动修复静态资源路径问题
- 确认前端文件已正确构建并位于`server/public`目录下

### 问题2: 出现ERR_MODULE_NOT_FOUND错误

**原因:** ESM模块解析问题，通常与vite.config.ts中的顶层await有关

**解决方案:**
- 使用`--external:vite.config.ts`参数跳过vite配置文件的打包
- 确保package.json中有`"type": "module"`设置

### 问题3: 内存不足 (OOM) 错误

**原因:** 构建过程中内存使用过多

**解决方案:**
- 使用`NODE_OPTIONS="--max-old-space-size=2048"`设置更大的内存限制
- 使用`memory-optimized-deploy.sh`脚本，它进行了内存优化

### 问题4: 应用启动后立即崩溃

**原因:** 可能是环境变量缺失或路径问题

**解决方案:**
- 检查日志确认具体错误
- 确保所有必需的环境变量都已设置
- 使用备用启动方法（脚本中已包含）

## 高级问题排查

如遇到其他复杂问题，可尝试以下排查方法：

1. **检查文件路径**
   ```bash
   # 在Replit Console中运行
   find dist -type f | sort
   ```

2. **验证静态文件服务**
   ```bash
   # 创建测试文件
   echo "Test file" > server/public/test.txt
   # 访问 /test.txt 查看是否可以访问
   ```

3. **检查环境变量**
   ```bash
   # 在Replit Console中运行
   env | grep NODE
   ```

4. **查看详细日志**
   ```bash
   # 启用调试日志
   NODE_ENV=production NODE_DEBUG=module node dist/start.js
   ```

## 部署检查清单

使用以下检查清单确保部署成功：

- [ ] 构建命令执行无错误
- [ ] dist目录包含前端资源
- [ ] server/public目录包含前端资源的副本
- [ ] 环境变量已正确设置
- [ ] 数据库连接正常
- [ ] 主应用页面可访问
- [ ] 所有API密钥有效

如果您遵循本指南中的步骤，应该能够成功部署并运行您的应用程序。