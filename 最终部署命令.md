# 最终部署命令

## 终极构建和运行命令

经过彻底分析，现提供最终解决方案：

### 构建命令
```bash
bash build.sh
```

### 运行命令
```bash
NODE_ENV=production node dist/startup.js
```

## 解决方案说明

这个最终解决方案解决了以下核心问题：

1. **ESM模块解析错误**：通过`--external:vite.config.ts`参数避免解析带有顶层await的vite配置文件
2. **依赖处理错误**：通过`--packages=external`参数保留所有外部依赖
3. **启动失败保险**：创建智能启动脚本，在编译失败时自动回退到tsx运行模式
4. **内存优化**：使用`NODE_OPTIONS="--max-old-space-size=2048"`限制内存使用，避免OOM
5. **package.json格式问题**：自动添加`"type": "module"`确保正确的模块格式

## 开发过程中的主要问题

1. **顶层await（TLA）问题**：vite.config.ts中的顶层await在CJS环境中无法处理
   - 解决：标记vite.config.ts为external

2. **模块解析路径问题**：ESM需要精确的文件扩展名
   - 解决：build.sh中自动处理相对导入路径

3. **备用启动方案**：当编译失败时需要备用方案
   - 解决：多模式智能启动脚本dist/startup.js

4. **前后端构建分离**：避免内存溢出
   - 解决：分阶段构建前端和后端

## 其他可选脚本

根据不同场景，也可以选择其他脚本：

- `simplified-build.sh` - 简化版构建脚本
- `memory-optimized-deploy.sh` - 内存优化版构建脚本
- `deploy-fix.sh` - 包含导入路径自动修复的构建脚本

对于大多数情况，推荐使用`build.sh`，它整合了所有解决方案。