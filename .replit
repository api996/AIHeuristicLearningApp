modules = ["nodejs-20", "bash", "web", "postgresql-16", "python-3.11", "python3"]
run = "npm run dev"
hidden = [".config", ".git", "generated-icon.png", "node_modules", "dist"]

[nix]
channel = "stable-24_05"

[deployment]
deploymentTarget = "cloudrun"
run = ["sh", "-c", "npm run dev"]

[[ports]]
localPort = 5000
externalPort = 80

[[ports]]
localPort = 5001
externalPort = 3000

[[ports]]
localPort = 5003
externalPort = 3001

[workflows]
runButton = "重建并修复记忆系统"

[[workflows.workflow]]
name = "Project"
mode = "parallel"
author = "agent"

[[workflows.workflow.tasks]]
task = "workflow.run"
args = "Start application"

[[workflows.workflow]]
name = "Start application"
author = "agent"

[workflows.workflow.metadata]
agentRequireRestartOnSave = false

[[workflows.workflow.tasks]]
task = "packager.installForAll"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"
waitForPort = 5000

[[workflows.workflow]]
name = "Start application (fixed)"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"

[[workflows.workflow]]
name = "Start application (clean)"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"

[[workflows.workflow]]
name = "重新启动应用"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:3000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"

[[workflows.workflow]]
name = "重启并修复管理员"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:3000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"

[[workflows.workflow]]
name = "重启服务器"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:3000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"

[[workflows.workflow]]
name = "重启并修复问题"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:3000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"

[[workflows.workflow]]
name = "启动调试模式"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "NODE_ENV=development npm run dev"

[[workflows.workflow]]
name = "重启RAG服务"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5001) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "NODE_ENV=development npm run dev"

[[workflows.workflow]]
name = "安装依赖并启动服务"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pip install --user google-generativeai"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5001) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "NODE_ENV=development npm run dev"

[[workflows.workflow]]
name = "重启Gemini服务"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pip install --upgrade google-generativeai"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5001) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "NODE_ENV=development npm run dev"

[[workflows.workflow]]
name = "更新依赖并重启服务"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pip install --upgrade google-generativeai numpy pandas scikit-learn"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5001) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "NODE_ENV=development npm run dev"

[[workflows.workflow]]
name = "重启并修复记忆系统"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5001) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "# 修复可能的目录权限问题"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "mkdir -p memory_space"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "chmod -R 755 memory_space"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "# 重新启动应用"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "NODE_ENV=development npm run dev"

[[workflows.workflow]]
name = "重建并修复记忆系统"
author = 40327554
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "pkill -f \"tsx server/index.ts\" || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5000) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "kill $(lsof -t -i:5001) 2>/dev/null || true"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "# 检查Python环境"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python3 -c \"import sys; print('Python版本:', sys.version); import google.generativeai; print('Gemini库已安装')\""

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "# 检查记忆目录"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "echo \"检查记忆目录:\""

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "ls -la memory_space"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "# 修复目录权限"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "mkdir -p memory_space/1 memory_space/2"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "chmod -R 755 memory_space"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "# 创建测试记忆"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "if [ ! -f memory_space/2/test_memory.json ]; then"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "  echo '{\"content\": \"这是测试记忆\", \"type\": \"system\", \"embedding\": [0.1, 0.2, 0.3], \"timestamp\": \"'$(date -Iseconds)'\"}' > memory_space/2/test_memory.json"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "fi"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "echo \"记忆文件示例:\""

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "ls -la memory_space/2/"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "# 重新启动应用"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "NODE_ENV=development npm run dev"
